---
apiVersion: argoproj.io/v1alpha1
kind: ArgoCD
metadata:
  name: openshift-gitops
  namespace: openshift-gitops
spec:
  kustomizeBuildOptions: --enable-alpha-plugins --enable-helm
  repo:
    env:
    - name: KUSTOMIZE_PLUGIN_HOME
      value: /etc/kustomize/plugin
    initContainers:
    - args:
      - -c
      - cp /etc/kustomize/plugin/policy.open-cluster-management.io/v1/policygenerator/PolicyGenerator
        /policy-generator/PolicyGenerator
      command:
      - /bin/bash
      image: registry.redhat.io/rhacm2/multicluster-operators-subscription-rhel8:v2.9
      name: policy-generator-install
      volumeMounts:
      - mountPath: /policy-generator
        name: policy-generator
    volumeMounts:
    - mountPath: /etc/kustomize/plugin/policy.open-cluster-management.io/v1/policygenerator
      name: policy-generator
    volumes:
    - emptyDir: {}
      name: policy-generator
  resourceTrackingMethod: annotation
  applicationInstanceLabelKey: "{{ git_app_instance_label_key }}"
  server:
    host: openshift-gitops-server-openshift-gitops.apps.{{ cluster_id }}.{{ base_domain }}
    route:
      enabled: true
      tls:
        insecureEdgeTerminationPolicy: Redirect
        termination: reencrypt
  resourceHealthChecks:
    - kind: Application
      group: argoproj.io
      check: |
        hs = {}
        if obj.status == nil or obj.status.health == nil then
          hs.status = "Progressing"
          hs.message = "Waiting for Application status"
          return hs
        end
        if obj.status.health.status == "Healthy" and obj.status.operationState == nil then
          hs.status = "Healthy"
          hs.message = ""
        elseif obj.status.health.status == "Healthy" and obj.status.operationState.phase == "Running" then
          hs.status = "Progressing"
          hs.message = obj.status.operationState.message
        else
          hs.status = obj.status.health.status
          hs.message = obj.status.operationState.message
        end
        return hs
    - kind: Subscription
      group: operators.coreos.com
      check: |
        health_status = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            numDegraded = 0
            numPending = 0
            msg = ""
            for i, condition in pairs(obj.status.conditions) do
              msg = msg .. i .. ": " .. condition.type .. " | " .. condition.status .. "\n"
              if (condition.type == "InstallPlanMissing" and condition.reason ~= "ReferencedInstallPlanNotFound") then
                numDegraded = numDegraded + 1
              elseif (condition.type == "CatalogSourcesUnhealthy" or condition.type == "InstallPlanFailed" or condition.type == "ResolutionFailed") and condition.status == "True" then
                numDegraded = numDegraded + 1
             end
           end
            if numDegraded == 0 and numPending == 0 then
              health_status.status = "Healthy"
              health_status.message = msg
              return health_status
            else
              health_status.status = "Degraded"
              health_status.message = msg
              return health_status
            end
          end
        end
        health_status.status = "Progressing"
        health_status.message = "An install plan for a subscription is pending installation"
        return health_status
    - kind: Cluster
      group: postgresql.cnpg.io
      check: |
        hs = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            for i, condition in pairs(obj.status.conditions) do
              if condition.type == "Ready" and condition.status == "True" then
                hs.status = "Healthy"
                hs.message = condition.message
                return hs
              end
            end
          end
        end
        hs.status = "Progressing"
        hs.message = "Waiting for Postgresql Cluster"
        return hs
    - kind: CatalogSource
      group: operators.coreos.com
      check: |
        hs = {}
        if obj.status ~= nil and obj.status.connectionState ~= nil then
          if obj.status.connectionState.lastObservedState == "READY" then
            hs.status = "Healthy"
            hs.message = "CatalogSource is ready"
            return hs
          end
        end
        hs.status = "Progressing"
        hs.message = "Waiting for CatalogSource to become ready"
        return hs
  configManagementPlugins: |-
    - name: kustomized-helm
      init:
        command: ["/bin/sh", "-c"]
        args: ["helm dependency build || true"]
      generate:
        command: ["/bin/sh", "-c"]
        args: ["helm template ../../helm_base --name-template $ARGOCD_APP_NAME --include-crds > ../../helm_base/all.yml && kustomize build"]  
...
